/*

ZVM - the ifvms.js Z-Machine (versions 5 and 8)
===============================================

Built: 2013-05-01

Copyright (c) 2011-2013 The ifvms.js team
BSD licenced
http://github.com/curiousdannii/ifvms.js

*/
var ZVM=function(){"use strict";function e(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function t(e){return[255&e>>24,255&e>>16,255&e>>8,255&e]}function n(e,t){return String.fromCharCode(e[t],e[t+1],e[t+2],e[t+3])}function r(e){return[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]}function i(e,t){return Function.prototype.bind?e.bind(t):function(){e.apply(t,[].slice.call(arguments))}}function s(e,t){for(var n in t)e[n]=t[n];return e}function o(e){return e<<16>>16}function a(e){return 65535&e}function u(e){for(var t=0,n=e.length,r=[];n>t;)r[t/2]=e[t++]<<8|e[t++];return r}function l(e){return e.replace(/(e\.)?U2S\(([^(]+?)\)/g,"(($2)<<16>>16)").replace(/(e\.)?S2U\(([^(]+?)\)/g,"(($2)&65535)").replace(/([\w.]+)\.getUint8\(([^(]+?)\)/g,"$1[$2]").replace(/([\w.]+)\.getUint16\(([^(]+?)\)/g,"($1[$2]<<8|$1[$2+1])")}function c(e,t){var n,r,i=[];for(n in e)t.indexOf(n)>=0&&(r=/function\s*\(([^(]*)\)\s*\{([\s\S]+)\}/.exec(""+e[n]),i.push(n+":function("+r[1]+"){"+l(r[2])+"}"));s(e,eval("({"+i.join()+"})"))}function _(e,t,n){return n=n||{},t&&(n.func=t),e.subClass(n)}function h(e,t){for(var n,r,i,s,a,u=0;e.ops.length-1>u;){if(e.ops[u].offset===t){if(2===e.ops.length-u&&e.ops[u+1].offset)return s=e.ops.pop(),a=e.ops.pop(),a.cond.invert=!a.cond.invert,s.cond=new T([a.cond,s.cond],"&&"),s.labels=a.labels.concat(s.labels),e.ops.push(s),1;n=new G(e.e,e.ops[u+1].pc),n.ops=e.ops.slice(u+1),r=n.ops.length-1,e.ops.length=u+1,i=e.ops[u],i.result=n,i.cond.invert=!i.cond.invert,s=n.ops[r],140===s.code&&o(s.operands[0].v)+s.next-2===i.pc?(i.keyword="while",n.ops.pop()):n.stopper=s.stopper;return 1}u++}}function f(e){return""+e}var d=function(){var e,t,n=0,r=/\b_super\b/,i=function(){};for(t in{toString:1})e=1;return i.subClass=function(t){var s,o,a,u=this.prototype,l=!/native code/.test(""+t.toString)&&t.toString,c=function(e,t){return function(){var n,r=this._super;return this._super=u[e],n=t.apply(this,arguments),this._super=r,n}};n=1,s=new this,n=0;for(o in t)s[o]="function"==typeof t[o]&&"function"==typeof u[o]&&r.test(t[o])?c(o,t[o]):t[o];return!e&&l&&(s.toString=r.test(l)?c("toString",l):l),a=s.init?function(){n||this.init.apply(this,arguments)}:function(){},a.prototype=s,a.constructor=a,a.subClass=i.subClass,a},i}(),p=d.subClass({init:function m(t){if(this.type="",this.chunks=[],t){if("FORM"!==n(t,0))throw Error("Not an IFF file");this.type=n(t,8);for(var r=12,i=t.length;i>r;){var s=e(t,r+4);if(0>s||s+r>i)throw Error("IFF: Chunk out of range");this.chunks.push({type:n(t,r),offset:r,data:t.slice(r+8,r+8+s)}),r+=8+s,s%2&&r++}}},write:function g(){for(var e=r(this.type),n=0,i=this.chunks.length;i>n;n++){var s=this.chunks[n],o=s.data,a=o.length;e=e.concat(r(s.type),t(a),o),a%2&&e.push(0)}return r("FORM").concat(t(e.length),e)}});p.num_from=e,p.num_to_word=t,p.text_from=n,p.text_to_word=r,[].indexOf||(Array.prototype.indexOf=function(e,t){for(var n=t||0,r=this.length;r>n;n++)if(this[n]===e)return n;return-1});var v=v!==void 0?v:{log:function(){},info:function(){},warn:function(){}},w,b,y=0,k=y?function(e){var t=new ArrayBuffer(e);return e=new DataView(t),e.buffer=t,e}:function(e){return e=e.slice(),ZVM?s(e,{data:e,getUint8:function(t){return e[t]},getUint16:function(t){return e[t]<<8|e[t+1]},getBuffer:function(t,n){return e.slice(t,t+n)},getBuffer16:function(t,n){return u(e.slice(t,t+2*n))},setUint8:function(t,n){return e[t]=255&n},setUint16:function(t,n){return e[t]=255&n>>8,e[t+1]=255&n,65535&n},setBuffer:function(t,n){for(var r=0,i=n.length;i>r;)e[r+t]=n[r++]}}):void 0},x=d.subClass({init:function(e,t){this.e=e,this.v=t},toString:function(){return this.v},U2S:function(){return o(this.v)}}),F=x.subClass({toString:function(){var e=this.v;return this.indirect?"e.indirect("+e+")":0===e?"s.pop()":15>--e?"l["+e+"]":"m.getUint16("+(this.e.globals+2*(e-15))+")"},store:function(e){var t=this.v;return this.indirect?"e.indirect("+t+","+e+")":this.returnval?"e.variable("+t+","+e+")":0===t?"s.push("+e+")":15>--t?"l["+t+"]="+e:"m.setUint16("+(this.e.globals+2*(t-15))+","+e+")"},U2S:function(){return"e.U2S("+this+")"}}),C=d.subClass({init:function(e,t,n,r,i,s){this.e=e,this.context=t,this.code=n,this.pc=r,this.labels=[this.pc+"/"+this.code],this.next=i,this.operands=s,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(e){return this.operands.join(e)},label:function(){return"/* "+this.labels.join()+" */ "}}),S=C.subClass({stopper:1}),E=S.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),T=d.subClass({init:function(e,t){this.ops=e||[],this.code=t||"||"},toString:function(){for(var e,t=0,n=[];this.ops.length>t;)e=this.ops[t++],n.push(e.func?(e.iftrue?"":"!(")+e.func.apply(e,e.operands)+(e.iftrue?"":")"):e);return(this.invert?"(!(":"(")+n.join(this.code)+(this.invert?"))":")")}}),U=C.subClass({brancher:1,keyword:"if",post:function(){var e,t,n=this.operands.pop(),r=n[1];this.iftrue=n[0],0===r||1===r?e="e.ret("+r+")":(r+=this.next-2,this.context.targets.push(r),e="e.pc="+r),this.result=e+";return",this.offset=r,this.cond=new T([this]),this.context.ops.length&&(t=this.context.ops.pop(),t.offset===r?(this.cond.ops.unshift(t.cond),this.labels=t.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(t))},toString:function(){var e=this.result;return e instanceof G&&(e+=e.stopper?"; return":"",this.result.ops.length>1&&(e="\n"+e+"\n")),this.label()+this.keyword+this.cond+" {"+e+"}"}}),M=U.subClass({storer:1,post:function(){this._super(),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),N=C.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var e=this._super();return this.storer?this.storer.store(e):e}}),j=S.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),Z=j.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),G=d.subClass({init:function(e,t){this.e=e,this.pc=t,this.pre=[],this.ops=[],this.post=[],this.targets=[]},toString:function(){return this.pre.join("")+this.ops.join(";")+this.post.join("")}}),z=G.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),this._super()}}),D=p.subClass({init:function(e){if(this._super(e),e){if("IFZS"!==this.type)throw Error("Not a Quetzal savefile");for(var t=0,n=this.chunks.length;n>t;t++){var r=this.chunks[t].type,i=this.chunks[t].data;"CMem"===r||"UMem"===r?(this.memory=i,this.compressed="CMem"===r):"Stks"===r?this.stacks=i:"IFhd"===r&&(this.release=i.slice(0,2),this.serial=i.slice(2,8),this.checksum=i.slice(8,10),this.pc=i[10]<<16|i[11]<<8|i[12])}}},write:function(){this.type="IFZS";var e=this.pc,t=this.release.concat(this.serial,this.checksum,255&e>>16,255&e>>8,255&e);return this.chunks=[{type:"IFhd",data:t},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}}),O=function(e){function t(t,n){for(var r in n)n[r]!==e&&(t[r]=n[r]);return t}function n(e){var t=Math.round(8.226*(31&e))<<16|Math.round(8.226*((992&e)>>5))<<8|Math.round(8.226*((31744&e)>>10));for(t=t.toString(16);6>t.length;)t="0"+t;return"#"+t}var r=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627];return d.subClass({colours:r,init:function(e,t){this.e=e,this.buffer="",this.styles={},this.env={fgcolour:e.env.fgcolour||"#000",bgcolour:e.env.bgcolour||"#fff"},this.mono=t,this.currentwin=0,this.status=[],e.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",css:t({},this.styles)})},convert_RGB:function(e){var t,n=Math.round,r=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(e);return r[1]?t=[r[1],r[2],r[3]]:(t=[parseInt(r[4],16),parseInt(r[5],16),parseInt(r[6],16)],4===e.length&&(t=[t[0]<<4|t[0],t[1]<<4|t[1],t[2]<<4|t[2]])),n(t[2]/8.226)<<10|n(t[1]/8.226)<<5|n(t[0]/8.226)},erase_line:function(e){1===e&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(e){this.flush(),1>e&&this.clear_window(),-1===e&&this.split_window(0),(-2===e||1===e)&&this.status.push({code:"clear"})},flush:function(){var e;""!==this.buffer&&(e={code:"stream",css:t({},this.styles),text:this.buffer},this.mono&&(e.node="tt"),(this.currentwin?this.status:this.e.orders).push(e),this.buffer="")},get_cursor:function(e){this.status.push({code:"get_cursor",addr:e}),this.e.act()},set_colour:function(e,t){this.set_true_colour(r[e],r[t])},set_cursor:function(e,t){this.flush(),this.status.push({code:"cursor",to:[e-1,t-1]})},set_font:function(e){if(1!==e&&4!==e)return 0;var t=4&this.mono?4:1;return e!==t&&(this.flush(),this.mono^=4),t},set_style:function(t){var n,r,i=this.styles;this.flush(),0===t&&(n=this.reverse,this.reverse=i["font-weight"]=i["font-style"]=e,this.mono&=254),1&t&&(n=!this.reverse,this.reverse=1),2&t&&(i["font-weight"]="bold"),4&t&&(i["font-style"]="italic"),8&t&&(this.mono|=1),n&&(r=i.color||this.env.fgcolour,i.color=i["background-color"]||this.env.bgcolour,i["background-color"]=r)},set_true_colour:function(t,r){var i,s=this.styles,o=s.color,a=s["background-color"];this.flush(),this.reverse&&(i=t,t=r,r=i),65535===t?o=e:32768>t&&(o=n(t)),65535===r?a=e:32768>r&&(a=n(r)),this.reverse&&(o=o||this.env.bgcolour,a=a||this.env.fgcolour),s.color=o,s["background-color"]=a},set_window:function(e){this.flush(),this.currentwin=e,this.e.orders.push({code:"find",name:e?"status":"main"}),e&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(e){this.flush(),this.status.push({code:"height",lines:e})}})}(),I=_(U,function(){return 1}),A=N.subClass({storer:0,post:function(){var e=this.operands,t=e[0],n=t instanceof F;e[0]=new F(this.e,n?t:t.v),(n||0===t.v)&&(e[0].indirect=1),this.storer=142===this.code?e.pop():e.shift(),0===e.length&&e.push(new F(this.e,0))},func:f}),R=C.subClass({func:function(e){var t=e.v-1,n=this.code%2?1:-1;return e instanceof F||t>14?"e.incdec("+e+","+n+")":(0>t?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+t+"]=e.S2U(e.l["+t+"]+")+n+")"}}),W={1:_(U,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:_(U,function(e,t){return e.U2S()+"<"+t.U2S()}),3:_(U,function(e,t){return e.U2S()+">"+t.U2S()}),4:_(U,function(e,t){return"e.U2S(e.incdec("+e+",-1))<"+t.U2S()}),5:_(U,function(e,t){return"e.U2S(e.incdec("+e+",1))>"+t.U2S()}),6:_(U,function(){return"e.jin("+this.args()+")"}),7:_(U,function(){return"e.test("+this.args()+")"}),8:_(N,function(){return this.args("|")}),9:_(N,function(){return this.args("&")}),10:_(U,function(){return"e.test_attr("+this.args()+")"}),11:_(C,function(){return"e.set_attr("+this.args()+")"}),12:_(C,function(){return"e.clear_attr("+this.args()+")"}),13:A,14:_(C,function(){return"e.insert_obj("+this.args()+")"}),15:_(N,function(e,t){return"m.getUint16(e.S2U("+e+"+2*"+t.U2S()+"))"}),16:_(N,function(e,t){return"m.getUint8(e.S2U("+e+"+"+t.U2S()+"))"}),17:_(N,function(){return"e.get_prop("+this.args()+")"}),18:_(N,function(){return"e.find_prop("+this.args()+")"}),19:_(N,function(){return"e.find_prop("+this.args(",0,")+")"}),20:_(N,function(){return"e.S2U("+this.args("+")+")"}),21:_(N,function(){return"e.S2U("+this.args("-")+")"}),22:_(N,function(){return"e.S2U("+this.args("*")+")"}),23:_(N,function(e,t){return"e.S2U(parseInt("+e.U2S()+"/"+t.U2S()+"))"}),24:_(N,function(e,t){return"e.S2U("+e.U2S()+"%"+t.U2S()+")"}),25:Z,26:j,27:_(C,function(){return"e.ui.set_colour("+this.args()+")"}),28:_(S,function(e,t){return"while(e.call_stack.length>"+t+"){e.call_stack.shift()}return "+e}),128:_(U,function(e){return e+"===0"}),129:_(M,function(e){return"e.get_sibling("+e+")"}),130:_(M,function(e){return"e.get_child("+e+")"}),131:_(N,function(e){return"e.get_parent("+e+")"}),132:_(N,function(e){return"e.get_prop_len("+e+")"}),133:R,134:R,135:_(C,function(e){return"e.print(2,"+e+")"}),136:Z,137:_(C,function(e){return"e.remove_obj("+e+")"}),138:_(C,function(e){return"e.print(3,"+e+")"}),139:_(S,function(e){return"return "+e}),140:_(S,function(e){return"e.pc="+e.U2S()+"+"+(this.next-2)}),141:_(C,function(e){return"e.print(2,"+e+"*"+this.e.addr_multipler+")"}),142:A.subClass({storer:1}),143:j,176:_(S,function(){return"return 1"}),177:_(S,function(){return"return 0"}),178:_(C,function(e){return"e.print(2,"+e+")"},{printer:1}),179:_(S,function(e){return"e.print(2,"+e+");e.print(1,13);return 1"},{printer:1}),180:C,183:_(S,function(){return"e.act(183)"}),184:_(S,function(e){return"return "+e},{post:function(){this.operands.push(new F(this.e,0))}}),185:_(N,function(){return"e.call_stack.length"}),186:_(S,function(){return"e.act(186)"}),187:_(C,function(){return"e.print(1,13)"}),189:I,191:I,224:Z,225:_(C,function(e,t,n){return"m.setUint16(e.S2U("+e+"+2*"+t.U2S()+"),"+n+")"}),226:_(C,function(e,t,n){return"m.setUint8(e.S2U("+e+"+"+t.U2S()+"),"+n+")"}),227:_(C,function(){return"e.put_prop("+this.args()+")"}),228:_(E,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:_(C,function(e){return"e.print(4,"+e+")"}),230:_(C,function(e){return"e.print(0,"+e.U2S()+")"}),231:_(N,function(e){return"e.random("+e.U2S()+")"}),232:_(N,f,{post:function(){this.storer=new F(this.e,0)},storer:0}),233:A,234:_(C,function(e){return"e.ui.split_window("+e+")"}),235:_(C,function(e){return"e.ui.set_window("+e+")"}),236:Z,237:_(C,function(e){return"e.ui.erase_window("+e.U2S()+")"}),238:_(C,function(e){return"e.ui.erase_line("+e+")"}),239:_(C,function(){return"e.ui.set_cursor("+this.args()+")"}),240:_(E,function(e){return"e.ui.get_cursor("+e+")"}),241:_(C,function(e){return"e.ui.set_style("+e+")"}),242:C,243:_(C,function(){return"e.output_stream("+this.args()+")"}),244:C,245:C,246:_(E,function(){return"e.read_char("+(this.args()||"1")+","+this.storer.v+")"}),247:_(M,function(){return"e.scan_table("+this.args()+")"}),248:_(N,function(e){return"e.S2U(~"+e+")"}),249:j,250:j,251:_(C,function(){return"e.tokenise("+this.args()+")"}),252:_(C,function(){return"e.encode_text("+this.args()+")"}),253:_(C,function(){return"e.copy_table("+this.args()+")"}),254:_(C,function(){return"e.print_table("+this.args()+")"}),255:_(U,function(e){return e+"<=e.call_stack[0][4]"}),1e3:_(E,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:_(E,function(){return"e.act(1001,"+this.storer.v+")"}),1002:_(N,function(e,t){return"e.S2U(e.log_shift("+e+","+t.U2S()+"))"}),1003:_(N,function(e,t){return"e.S2U(e.art_shift("+e.U2S()+","+t.U2S()+"))"}),1004:_(N,function(e){return"e.ui.set_font("+e+")"}),1009:_(N,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:_(C,function(){return"if(e.restore_undo())return"},{storer:1}),1011:_(C,function(e){return"e.print(1,"+e+")"}),1012:_(N,function(){return 3}),1013:_(C,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:C.subClass({brancher:1}),1030:_(N,function(){return"e.gestalt("+this.args()+")"})},B=d.subClass({art_shift:function(e,t){return t>0?e<<t:e>>-t},call:function(e,t,n,r){var i,s,o=this.l.length,a=r.length;for(this.pc=e*this.addr_multipler,s=this.m.getUint8(this.pc++),r=r.slice(0,s),i=r.length;s>i;i++)r.push(0);this.l=r.concat(this.l),this.call_stack.unshift([n,t,s,this.s.length,a,o])},clear_attr:function(e,t){var n=0|this.objects+14*e+t/8;this.m.setUint8(n,this.m.getUint8(n)&~(128>>t%8))},copy_table:function(e,t,n){n=o(n);var r=this.m,i=0,s=0>n;if(n=Math.abs(n),0!==t)if(s)for(;n>i;)r.setUint8(t+i,r.getUint8(e+i++));else r.setBuffer(t,r.getBuffer(e,n));else for(;n>i;)r.setUint8(e+i++,0)},encode_text:function(e,t,n,r){this.m.setBuffer(r,this.encode(this.m.getBuffer(e+n,t)))},extension_table:function(e,t){var n=this.extension;return!n||e>this.extension_count?0:(n+=2*e,void 0===t?this.m.getUint16(n):(this.e.setUint16(n,t),void 0))},find_prop:function(e,t,n){var r,i,s=this.m,o=0,a=s.getUint16(this.objects+14*e+12);for(a+=2*s.getUint8(a)+1;;){if(r=s.getUint8(a),i=63&r,o===n)return i;if(i===t)return a+(128&r?2:1);if(t>i)return 0;o=i,128&r?(i=63&s.getUint8(a+1),a+=i?i+2:66):a+=64&r?3:2}},gestalt:function(e){switch(e){case 1:return 258;case 8192:case 48:case 49:return 1;case 8193:case 8194:return 2}return 0},get_child:function(e){return this.m.getUint16(this.objects+14*e+10)},get_sibling:function(e){return this.m.getUint16(this.objects+14*e+8)},get_parent:function(e){return this.m.getUint16(this.objects+14*e+6)},get_prop:function(e,t){var n=this.m,r=this.find_prop(e,t);return r?(64&n.getUint8(r-1)?n.getUint16:n.getUint8)(r):n.getUint16(this.properties+2*(t-1))},get_prop_len:function(e){if(0===e)return 0;var t=this.m.getUint8(e-1);return 128&t?(t&=63,0===t?64:t):64&t?2:1},incdec:function(e,t){var n,r;return 0===e?(n=a(this.s.pop()+t),this.s.push(n),n):15>--e?this.l[e]=a(this.l[e]+t):(r=this.globals+2*(e-15),this.m.setUint16(r,this.m.getUint16(r)+t))},indirect:function(e,t){return 0===e?arguments.length>1?this.s[this.s.length-1]=t:this.s[this.s.length-1]:this.variable(e,t)},insert_obj:function(e,t){this.remove_obj(e),this.set_family(e,t,t,e,e,this.get_child(t))},jeq:function(){for(var e,t=1;arguments.length>t;)arguments[t++]===arguments[0]&&(e=1);return e},jin:function(e,t){return this.get_parent(e)===t},log_shift:function(e,t){return t>0?e<<t:e>>>-t},output_stream:function(e,t){if(e=o(e),1===e&&(this.streams[0]=1),-1===e&&(this.streams[0]=0),3===e&&this.streams[2].unshift([t,""]),-3===e){var n=this.streams[2].shift(),r=this.text_to_zscii(n[1]);this.m.setUint16(n[0],r.length),this.m.setBuffer(n[0]+2,r)}if(5===e&&(this.ui.flush(),this.ui.e.outputEvent(this.ui.e.orders),this.ui.e.orders=[],this.streams[4].unshift([t,""])),-5===e){n=this.streams[4].shift();try{r=this.text_to_zscii(""+window.eval(n[1]))}catch(i){v.log("Invalid JavaScript: "+n[1])}this.m.setUint16(n[0],r.length),this.m.setBuffer(n[0]+2,r)}if(6===e&&this.streams[5].unshift([t,""]),-6===e){n=this.streams[5].shift();var s=n[1].split(" ")[0],a=n[1].split(" ");a.shift(),a=a.join(" "),this.ui.buffer+="<"+s+' class="'+a+'"></'+s+">",this.ui.flush(),this.ui.e.outputEvent(this.ui.e.orders),this.ui.e.orders=[]}},_print:function(e){if(this.streams[2].length)this.streams[2][0][1]+=e;else if(this.streams[4].length)this.streams[4][0][1]+=e;else if(this.streams[5].length)this.streams[5][0][1]+=e;else if(this.streams[0]){var t=2&this.m.getUint8(17);t!==(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=e}},print:function(e,t){if(0===e&&(t=""+t),1===e&&(t=String.fromCharCode(t)),2===e&&(t=this.jit[t]||this.decode(t)),3===e){var n=this.m.getUint16(this.objects+14*t+12);t=this.decode(n+1,2*this.m.getUint8(n))}if(4===e){if(!this.unicode_table[t])return;t=this.unicode_table[t]}this._print(t)},print_table:function(e,t,n,r){n=n||1,r=r||0;for(var i=0;n>i;)this._print("\r"+this.zscii_to_text(this.m.getBuffer(e,t))),e+=t+r,i++},put_prop:function(e,t,n){var r=this.m,i=this.find_prop(e,t);(64&r.getUint8(i-1)?r.setUint16:r.setUint8)(i,n)},random:function(e){return 1>e?(this.random_state=Math.abs(e),this.random_seq=0,0):0===this.random_state?1|Math.random()*e:(this.random_seq++,this.random_seq>this.random_state&&(this.random_seq=1),this.random_seq%e)},read:function(e,t,n,r,i){3===arguments.length&&(i=n,n=r=0),this.act("read",{buffer:e,parse:t,len:this.m.getUint8(e),initiallen:this.m.getUint8(e+1),time:n,routine:r,storer:i})},read_char:function(e,t,n,r){2===arguments.length&&(r=t,t=n=0),this.act("char",{time:t,routine:n,storer:r})},remove_obj:function(e){var t,n,r,i=this.get_parent(e);if(0!==i)if(t=this.get_child(i),n=this.get_sibling(e),t===e)this.set_family(e,0,i,n);else{for(;;){if(r=this.get_sibling(t),r===e)break;t=r}this.set_family(e,0,0,0,t,n)}},restart:function(){var e=k(this.data),t=e.getUint8(0),n=5===t?4:8,r=e.getUint16(10),i=e.getUint16(54);if(5!==t&&8!==t)throw Error("Unsupported Z-Machine version: "+t);this.m&&e.setUint8(17,this.m.getUint8(17)),s(this,{m:e,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0,[],[]],version:t,pc:e.getUint16(6),properties:r,objects:r+112,globals:e.getUint16(12),staticmem:e.getUint16(14),eof:(e.getUint16(26)||65536)*n,extension:i,extension_count:i?e.getUint16(i):0,addr_multipler:n}),this.ui=new O(this,2&e.getUint8(17)),this.init_text(),this.update_header()},restore:function(e){var t,n,r=new D(e),i=r.memory,s=r.stacks,o=r.pc,a=this.m.getUint8(17),l=0,c=0,_=[],h=[];if(this.m.setBuffer(0,this.data.slice(0,this.staticmem)),r.compressed)for(;i.length>l;)t=i[l++],0===t?c+=1+i[l++]:this.m.setUint8(c,t^this.data[c++]);else this.m.setBuffer(0,i);for(this.m.setUint8(17,a),l=6,t=s[l++]<<8|s[l++],n=u(s.slice(l,t));s.length>l;){for(_.unshift([s[l++]<<16|s[l++]<<8|s[l++],0,0,n.length,0,h.length]),_[0][1]=16&s[l]?-1:s[l+1],_[0][2]=15&s[l],l+=2,t=s[l++];t;)_[0][4]++,t>>=1;t=s[l++]<<8|s[l++],h=u(s.slice(l,l+_[0][2])).concat(h),l+=2*_[0][2],n=n.concat(u(s.slice(l,t)))}this.call_stack=_,this.l=h,this.s=n,this.update_header(),this.variable(this.m.getUint8(o++),2),this.pc=o},restore_undo:function(){if(0===this.undo.length)return 0;var e=this.undo.pop();return this.pc=e[0],e[2][17]=this.m.getUint8(17),this.m.setBuffer(0,e[2]),this.l=e[3],this.s=e[4],this.call_stack=e[5],this.variable(e[1],2),1},ret:function(e){var t=this.call_stack.shift(),n=t[1];this.pc=t[0],this.l=this.l.slice(this.l.length-t[5]),this.s.length=t[3],n>=0&&this.variable(n,e)},save:function(e,t){var n,r,i,s,o,a=this.m,u=this.s,l=this.l,c=new D,_=[],h=0,f=this.call_stack.reverse(),d=[0,0,0,0,0,0];for(c.release=a.getBuffer(2,2),c.serial=a.getBuffer(18,6),c.checksum=a.getBuffer(28,2),c.pc=e,c.compressed=1,n=0;this.staticmem>n;n++)i=a.getUint8(n)^this.data[n],0===i?256===++h&&(_.push(0,255),h=0):(h&&(_.push(0,h-1),h=0),_.push(i));for(c.memory=_,d.push(f[0][3]>>8,255&f[0][3]),r=0;f[0][3]>r;r++)d.push(u[r]>>8,255&u[r]);for(n=0;f.length>n;n++){for(s=f[n],o=(f[n+1]?f[n+1][3]:u.length)-s[3],d.push(s[0]>>16,255&s[0]>>8,255&s[0],s[2]|(0>s[1]?16:0),0>s[1]?0:s[1],(1<<s[4])-1,o>>8,255&o),r=l.length-s[5]-s[2];l.length-s[5]>r;r++)d.push(l[r]>>8,255&l[r]);for(r=s[3];s[3]+o>r;r++)d.push(u[r]>>8,255&u[r])}f.reverse(),c.stacks=d,this.act("save",{data:c.write(),storer:t})},save_undo:function(e,t){return this.undo.push([e,t,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(e,t,n,r){r=r||130;var i=128&r?this.m.getUint16:this.m.getUint8;for(r&=127,n=t+n*r;n>t;){if(i(t)===e)return t;t+=r}return 0},set_attr:function(e,t){var n=0|this.objects+14*e+t/8;this.m.setUint8(n,this.m.getUint8(n)|128>>t%8)},set_family:function(e,t,n,r,i,s){this.m.setUint16(this.objects+14*e+6,t),n&&this.m.setUint16(this.objects+14*n+10,r),i&&this.m.setUint16(this.objects+14*i+8,s)},test:function(e,t){return e&t===t},test_attr:function(e,t){return 128&this.m.getUint8(0|this.objects+14*e+t/8)<<t%8},update_header:function(){var e=this.m,t=this.env.fgcolour?this.ui.convert_RGB(this.env.fgcolour):65535,n=this.env.bgcolour?this.ui.convert_RGB(this.env.bgcolour):65535;this.random_state=0,e.setUint8(1,29|(this.env.timed?128:0)),e.setUint8(17,87&e.getUint8(17)),e.setUint8(32,255),e.setUint8(33,this.env.width),e.setUint16(34,this.env.width),e.setUint16(36,255),e.setUint16(38,257),e.setUint8(44,Math.abs(this.ui.colours.indexOf(n))),e.setUint8(45,Math.abs(this.ui.colours.indexOf(t))),e.setUint16(50,258),this.extension_table(4,0),this.extension_table(5,t),this.extension_table(6,n)},variable:function(e,t){var n,r=void 0!==t;if(0===e){if(!r)return this.s.pop();this.s.push(t)}else if(15>--e){if(!r)return this.l[e];this.l[e]=t}else{if(n=this.globals+2*(e-15),!r)return this.m.getUint16(n);this.m.setUint16(n,t)}return t},U2S:o,S2U:a,init_text:function(){function e(e){for(var t=[[],[],[]],r=0;78>r;)t[0|r/26][r%26]=e[r++];t[2][1]=13,n.alphabets=t}function t(e){for(var t={13:"\r"},r={13:13},i=0;e.length>i;)t[155+i]=String.fromCharCode(e[i]),r[e[i]]=155+i++;for(i=32;127>i;)t[i]=String.fromCharCode(i),r[i]=i++;n.unicode_table=t,n.reverse_unicode_table=r}var n=this,r=this.m,i=r.getUint16(52),s=this.extension_table(3),o=s&&r.getUint8(s++);e(i?r.getBuffer(i,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),t(s?r.getBuffer16(s,o):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=r.getUint16(8),this.parse_dict(this.dict)},decode:function(e,t){var n,r,s,o,a=this.m,u=e,l=[],c=0,_=0,h=[],f=[],d=0;if(this.jit[e])return this.jit[e];for(t=t?t+e:this.eof;t>e&&(n=a.getUint16(e),e+=2,l.push(31&n>>10,31&n>>5,31&n),!(32768&n)););for(;l.length>c;){if(r=l[c++],0===r)h.push(32);else if(4>r)s=1,h.push(-1),f.push("\ue000+this.abbr("+(32*(r-1)+l[c++])+")+\ue000");else if(6>r)_=r;else if(2===_&&6===r){if(l.length>c+1)if(o=l[c++]<<5|l[c++],768>o)h.push(o);else{for(o-=767,d+=o,n=c,c=c%3+3;o--;)h.push(-1),f.push(String.fromCharCode(l[c]<<10|l[c+1]<<5|l[c+2])),l[c++]=l[c++]=l[c++]=32;c=n}}else 32>r&&h.push(this.alphabets[_][r-6]);_=4>_?0:_-3,0===c%3&&(c+=d,d=0)}return h=this.zscii_to_text(h,f),s&&(h={toString:i(Function('return"'+h.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"'),this)}),u>=this.staticmem&&(this.jit[u]=h),h},encode:function(e){for(var t,n,r=this.alphabets,i=[],s=0,o=[];9>i.length;)t=e[s++],32===t?i.push(0):(n=r[0].indexOf(t))>=0?i.push(n+6):(n=r[1].indexOf(t))>=0?i.push(4,n+6):(n=r[2].indexOf(t))>=0?i.push(5,n+6):(n=this.reverse_unicode_table[t])?i.push(5,6,n>>5,31&n):void 0===t&&i.push(5);for(i.length=9,s=0;9>s;)o.push(i[s++]<<2|i[s]>>3,(7&i[s++])<<5|i[s++]);return o[4]|=128,o},zscii_to_text:function(e,t){for(var n,r=0,i=e.length,s=0,o="";i>r;)n=e[r++],-1===n&&(o+=t[s++]),(n=this.unicode_table[n])&&(o+=n);return o},text_to_zscii:function(e,t){for(var n,r=[],i=0,s=e.length;s>i;)n=e.charCodeAt(i++),t||(n=this.reverse_unicode_table[n]||63),r.push(n);return r},parse_dict:function(e){var t,n,r=this.m,i=e,s={},o=r.getUint8(e++);for(s.separators=r.getBuffer(e,o),e+=o,t=r.getUint8(e++),n=e+2+t*r.getUint16(e),e+=2;n>e;)s[""+r.getBuffer(e,6)]=e,e+=t;return this.dictionaries[i]=s,s},abbr:function(e){var t=this.m;return this.decode(2*t.getUint16(t.getUint16(24)+2*e))},tokenise:function(e,t,n,r){n=n||this.dict,n=this.dictionaries[n]||this.parse_dict(n);for(var i,s,o=this.m,a=2,u=a+o.getUint8(e+1),l=n.separators,c=[],_=[],h=a,f=0;u>a;)i=o.getUint8(e+a++),32===i||l.indexOf(i)>=0?(c.length&&(_.push([c,h]),h+=c.length,c=[]),32!==i&&_.push([[i],h]),h++):c.push(i);for(c.length&&_.push([c,h]),s=Math.min(_.length,o.getUint8(t));s>f;)c=n[""+this.encode(_[f][0])],(!r||c)&&(o.setUint16(t+2+4*f,c||0),o.setUint8(t+4+4*f,_[f][0].length),o.setUint8(t+5+4*f,_[f][1])),f++;o.setUint8(t+1,f)},keyinput:function(e){var t=e.charCode,n=e.keyCode,r=function(){for(var e={8:8,13:13,27:27,37:131,38:129,39:132,40:130},t=96;106>t;)e[t]=49+t++;for(t=112;124>t;)e[t]=21+t++;return e}();return r[n]?r[n]:this.reverse_unicode_table[t]||63},disassemble:function(){function e(e,t){for(var n=0;4>n;n++)t.push((192&e)>>6),e<<=2}for(var t,n,r,i,s,o,a,u=this.m,l=new z(this,this.pc);;){if(n=t=this.pc,i=u.getUint8(t++),190===i?(o=-1,i=u.getUint8(t++)+1e3):128&i?64&i?(o=-1,32&i||(i&=31)):(o=[(48&i)>>4],3>o[0]&&(i&=207)):(o=[64&i?2:1,32&i?2:1],i&=31),!W[i])throw this.stop=1,Error("Unknown opcode #"+i+" at pc="+n);for(s=W[i].prototype,-1===o&&(o=[],e(u.getUint8(t++),o),(236===i||250===i)&&e(u.getUint8(t++),o)),a=[],r=0;o.length>r;)0===o[r]&&(a.push(new x(this,u.getUint16(t))),t+=2),1===o[r]&&a.push(new x(this,u.getUint8(t++))),2===o[r++]&&a.push(new F(this,u.getUint8(t++)));if(s.storer&&a.push(new F(this,u.getUint8(t++))),s.brancher&&(r=u.getUint8(t++),a.push([128&r,64&r?63&r:(r<<8|u.getUint8(t++))<<18>>18])),s.printer)for(a.push(t);this.eof>t&&(r=u.getUint8(t),t+=2,!(128&r)););if(this.pc=t,l.ops.push(new W[i](this,l,i,n,t,a)),r=0,l.targets.indexOf(t)>=0&&(r=h(l,t)),s.stopper&&!r)break}return l},init:function(){this.jit={},this.env={width:80},c(this,["find_prop"])},inputEvent:function(e){var t,n=this.m,r=e.code;if(!e.env||(s(this.env,e.env),r)){if("load"===r)return this.data=e.data,void 0;this.orders=[],"restart"===r&&this.restart(),"save"===r&&this.variable(e.storer,e.result||1),"restore"===r&&(this.m||this.restart(),e.data?this.restore(e.data):this.variable(e.storer,0)),"read"===r&&(this.variable(e.storer,isNaN(e.terminator)?13:e.terminator),t=e.response,this._print(t+"\r"),t=this.text_to_zscii(t.toLowerCase()),t.length>e.len&&(t=t.slice(0,e.len)),n.setUint8(e.buffer+1,t.length),n.setBuffer(e.buffer+2,t),e.parse&&this.tokenise(e.buffer,e.parse)),"char"===r&&this.variable(e.storer,this.keyinput(e.response)),"get_cursor"===r&&(n.setUint16(e.addr,e.pos[0]+1),n.setUint16(e.addr+2,e.pos[1]+1)),this.run()}},run:function(){var e,t,n=new Date,r=0;for(this.stop=0;!this.stop;)if(e=this.pc,this.jit[e]||this.compile(),t=this.jit[e](this),isNaN(t)||this.ret(t),0===++r%5e4&&new Date-n>5e3)return this.act("tick"),void 0},compile:function(){var e=this.disassemble(),t,n;this.jit[e.pc]=Function("e",l(""+e)),e.pc<this.staticmem&&v.warn("Caching a JIT function in dynamic memory: "+e.pc)},act:function(e,t){t=t||{},183===e&&(e="restart"),186===e&&(e="quit"),1001===e&&(e="restore",t={storer:t}),this.ui.flush(),this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]),t.code=e,this.orders.push(t),this.stop=1,this.outputEvent&&this.outputEvent(this.orders)}});return"object"==typeof module&&"object"==typeof module.exports&&(module.exports=B),B}();